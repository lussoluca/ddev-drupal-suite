#!/usr/bin/env bash

## #ddev-generated
## Description: Check for standards compliance with PHPCS.
## Usage: phpcs <module_name> [fix]
## Example: phpcs ai
## ExecRaw: true

set -e

# Validate arguments
if [ $# -eq 0 ]; then
    echo "Error: Module name is required."
    echo "Usage: phpcs <module_name>"
    echo "Example: phpcs ai"
    exit 1
fi

MODULE_NAME="$1"
FIX="$2"

# Validate module name (Drupal machine name format)
if [[ ! "$MODULE_NAME" =~ ^[a-z][a-z0-9_]*$ ]]; then
    echo "Error: Invalid module name '$MODULE_NAME'."
    echo "Module name must:"
    echo "  - Start with a lowercase letter"
    echo "  - Contain only lowercase letters, numbers, and underscores"
    echo "  - Not start with a number or underscore"
    exit 1
fi

cd "$DDEV_COMPOSER_ROOT" || exit 1

COMMAND="phpcs"
if [[ $FIX == "fix" ]]; then
  COMMAND="phpcbf"
fi

if ! command -v $COMMAND >/dev/null; then
  echo "$COMMAND is not available. You may need to 'ddev composer install'"
  exit 1
fi

if [ -f "$DDEV_DOCROOT/modules/contrib/$MODULE_NAME/phpcs.xml.dist" ]; then
  echo "Using custom PHPCS ruleset for module '$MODULE_NAME'."
  $COMMAND \
    -s \
    --standard=$DDEV_DOCROOT/modules/contrib/$MODULE_NAME/phpcs.xml.dist \
    --basepath=$DDEV_DOCROOT/modules/contrib/$MODULE_NAME \
    --report-full --report-summary --report-source \
    $DDEV_DOCROOT/modules/contrib/$MODULE_NAME
else
  echo "Using default PHPCS ruleset."
  curl -OL https://git.drupalcode.org/project/gitlab_templates/-/raw/default-ref/assets/phpcs.xml.dist
  $COMMAND -s --report-full --report-summary --report-source $DDEV_DOCROOT/modules/contrib/$MODULE_NAME
fi
